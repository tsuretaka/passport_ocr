# 開発ログ - パスポートOCR転記システム (passport_ocr)

## 2026-01-31
- **新規作成**: プロジェクト立ち上げ
    - `res_card_ocr` をベースに、パスポート読み取り専用アプリを作成。
    - **機能実装**:
        1. **パスポート読み取り**: MRZ（機械読取領域）の解析ロジック (`ocr_utils.py`) を実装。
        2. **Excel転記**: 読み取ったデータをExcelファイルに保存する機能 (`excel_utils.py`) を実装。
        3. **一括処理**: フォルダ指定による画像のBatch OCR処理を実装。
        4. **ログイン機能**: `streamlit-authenticator` を使用し、ユーザーごとに保存フォルダ (`./data/userX`) を分離。
    - **バグ修正**: `streamlit-authenticator` のバージョン互換性問題（`preauthorized` 引数の削除、`st.session_state` ベースのログイン判定への変更）を修正。

- **機能改善**: OCR精度向上と項目追加
    - **ハイブリッド解析**: Google Vision APIの座標情報(`text_annotations`)を活用し、MRZ（下部コード）だけでなく券面(VIZ)の配置解析を取り入れた「ハイブリッドOCR」へ移行。
    - **レイアウト対応**: 日本のパスポート（特に2020年版）のレイアウト特性（項目名の下に値がある、"Expiry"などの配置）に合わせ、検索ロジックを最適化。
    - **項目追加**: 「本籍 (Registered Domicile)」と「発行年月日 (Date of issue)」の自動読み取りを追加。
    - **データ補正**: 国籍の厳格化（JPNのみ抽出）、本籍のノイズ除去（`*`削除）、日付フォーマットの統一を実施。
    - **Excelマイグレーション**: 保存項目が増えた際に、既存のExcelファイルを自動的に新フォーマット（列追加・並び替え）に更新する機能を追加。
    - **結果**: サンプル画像3枚（HEIC/PNG含む）にて、旅券番号・氏名・日付・本籍など全項目の「完璧な読み取り」を確認。

- **機能追加・仕様変更 (Cloud/Secure Mode)**:
    - **本籍読み取り改善**: 「発行年月日」などの隣接ラベルが混入する問題を修正し、精度を向上。
    - **渡航要件チェック**: データ管理タブに「入国日」と「必要残存日数」からパスポート有効期限を判定する機能を追加。
    - **クラウド運用対応**:
        - **インメモリ処理**: データ保存先をローカルファイルからブラウザ上のセッションメモリに変更（個人情報保護）。
        - **一括アップロード**: フォルダパス指定を廃止し、ドラッグ＆ドロップによる複数ファイルアップロードへ変更。
        - **ダウンロード必須化**: 処理結果をExcelファイルとしてダウンロードする機能を実装。
