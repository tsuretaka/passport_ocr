# 開発ログ - パスポートOCR転記システム (passport_ocr)

## 2026-01-31
- **新規作成**: プロジェクト立ち上げ
    - `res_card_ocr` をベースに、パスポート読み取り専用アプリを作成。
    - **機能実装**:
        1. **パスポート読み取り**: MRZ（機械読取領域）の解析ロジック (`ocr_utils.py`) を実装。
        2. **Excel転記**: 読み取ったデータをExcelファイルに保存する機能 (`excel_utils.py`) を実装。
        3. **一括処理**: フォルダ指定による画像のBatch OCR処理を実装。
        4. **ログイン機能**: `streamlit-authenticator` を使用し、ユーザーごとに保存フォルダ (`./data/userX`) を分離。
    - **バグ修正**: `streamlit-authenticator` のバージョン互換性問題（`preauthorized` 引数の削除、`st.session_state` ベースのログイン判定への変更）を修正。

- **機能改善**: OCR精度向上と項目追加
    - **ハイブリッド解析**: Google Vision APIの座標情報(`text_annotations`)を活用し、MRZ（下部コード）だけでなく券面(VIZ)の配置解析を取り入れた「ハイブリッドOCR」へ移行。
    - **レイアウト対応**: 日本のパスポート（特に2020年版）のレイアウト特性（項目名の下に値がある、"Expiry"などの配置）に合わせ、検索ロジックを最適化。
    - **項目追加**: 「本籍 (Registered Domicile)」と「発行年月日 (Date of issue)」の自動読み取りを追加。
    - **データ補正**: 国籍の厳格化（JPNのみ抽出）、本籍のノイズ除去（`*`削除）、日付フォーマットの統一を実施。
    - **Excelマイグレーション**: 保存項目が増えた際に、既存のExcelファイルを自動的に新フォーマット（列追加・並び替え）に更新する機能を追加。
    - **結果**: サンプル画像3枚（HEIC/PNG含む）にて、旅券番号・氏名・日付・本籍など全項目の「完璧な読み取り」を確認。

- **機能追加・仕様変更 (Cloud/Secure Mode)**:
    - **本籍読み取り改善**: 「発行年月日」などの隣接ラベルが混入する問題を修正し、精度を向上。
    - **渡航要件チェック**: データ管理タブに「入国日」と「必要残存日数」からパスポート有効期限を判定する機能を追加。
    - **クラウド運用対応**:
        - **インメモリ処理**: データ保存先をローカルファイルからブラウザ上のセッションメモリに変更（個人情報保護）。
        - **一括アップロード**: フォルダパス指定を廃止し、ドラッグ＆ドロップによる複数ファイルアップロードへ変更。
        - **ダウンロード必須化**: 処理結果をExcelファイルとしてダウンロードする機能を実装。

> **🚧 作業中断 (2026-01-31)**
> **状況**: Streamlit Cloudへのデプロイ中。Privateリポジトリの参照権限エラーでデプロイが完了していない状態。
> **次のステップ**: 
> 1. GitHubの権限設定を修正する（またはリポジトリをPublicにする）。
> 2. Streamlit Cloudで「Create app」を再試行。
> 3. Advanced SettingsのSecretsに `secrets_for_deployment.toml` の内容を設定してデプロイ完了させる。

## 2026-02-04
- **バグ修正・機能改善 (OCR & Data Management)**:
    - **OCR正規化強化**: 
        - 全角文字（`ＫＡＮＡＴＡ`）が半角に変換されない問題を修正。
        - キャッシュ問題を回避するためのローカル正規化関数 `force_normalize` および強力なホワイトリスト方式 `aggressive_normalize` を実装。
        - 氏名にはMRZ優先、数字・日付にはVIZ優先の「ハイブリッドマージ戦略」を採用し、空白混入や誤読（`K` vs `<`）を解消。
    - **データ管理機能の刷新**:
        - **並び替え機能**: `streamlit-aggrid` を導入し、ドラッグ＆ドロップによる行の並び替えを実現。
        - **編集・削除**: AgGrid上でのダブルクリック編集、およびチェックボックスによる複数行削除機能を実装。
        - **操作性向上**:
            - **即時同期**: JavaScript (`onRowDragEnd`) を注入し、ドラッグ終了時に自動的にシステムへデータを同期する機能を追加（「保存してリセット」問題を解決）。
            - **強制更新**: 環境依存の問題に備え、「並び順を強制更新」ボタンを設置。
            - **全件確認**: 保存前に全データの順序を確認できる「全件リスト表示（Expander）」を追加。
            - **選択バグ修正**: 削除時に発生していた `ValueError` を修正。
    - **マニュアル作成**:
        - ログインからOCR読取、新しいデータ管理機能（並び替え手順など）までを網羅した `MANUAL.md` を作成。

- **デプロイ準備**:
    - `requirements.txt` に `streamlit-aggrid` を追加。

> **✅ 開発完了 (2026-02-04)**
> **状況**: 全ての修正と新機能の実装が完了し、安定動作を確認。
> **次のステップ (再開時)**:
> 1. 必要に応じて、新しいフォーマットのパスポートや特殊な画像のテストを実施。
> 2. デプロイ環境での動作最終確認。
